name: Build and Push Docker Image

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string

env:
  REGISTRY_GHCR: ghcr.io
  IMAGE_NAME: yansdmusic

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: æ„å»ºé¡¹ç›®
      run: npm run build

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ° GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æ„å»ºé•œåƒæ ‡ç­¾
      run: |
        REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        echo "IMAGE_TAG=${{ env.REGISTRY_GHCR }}/${REPO_OWNER_LOWER}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.version }}" >> $GITHUB_ENV
        echo "IMAGE_LATEST=${{ env.REGISTRY_GHCR }}/${REPO_OWNER_LOWER}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_ENV

    - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.IMAGE_TAG }}
          ${{ env.IMAGE_LATEST }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ç”Ÿæˆéƒ¨ç½²è¯´æ˜
      run: |
        cat << EOF > deployment-instructions.md
        # çƒŸç¥æ®¿éŸ³ä¹ - Docker éƒ¨ç½²è¯´æ˜
        
        ## é•œåƒä¿¡æ¯
        - **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
        - **é•œåƒ**: \`${{ env.IMAGE_TAG }}\`
        - **æ„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - **ä»“åº“**: GitHub Container Registry
        
        ## å¿«é€Ÿéƒ¨ç½²
        
        ### ä½¿ç”¨ Docker è¿è¡Œ
        \`\`\`bash
        docker run -d \\
          --name yansdmusic \\
          -p 80:80 \\
          ${{ env.IMAGE_TAG }}
        \`\`\`
        
        ### ä½¿ç”¨ Docker Compose
        \`\`\`yaml
        version: '3.8'
        services:
          yansdmusic:
            image: ${{ env.IMAGE_TAG }}
            container_name: yansdmusic
            ports:
              - "80:80"
            restart: unless-stopped
            environment:
              - TZ=Asia/Shanghai
        \`\`\`
        
        ### è‡ªå®šä¹‰ç«¯å£è¿è¡Œ
        \`\`\`bash
        docker run -d \\
          --name yansdmusic \\
          -p 8080:80 \\
          ${{ env.IMAGE_TAG }}
        \`\`\`
        
        ## è®¿é—®åœ°å€
        éƒ¨ç½²å®Œæˆåï¼Œå¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š
        - æœ¬åœ°è®¿é—®: http://localhost
        - è‡ªå®šä¹‰ç«¯å£: http://localhost:8080
        
        ## é•œåƒç‰¹æ€§
        - åŸºäº Nginx Alpine é•œåƒï¼Œä½“ç§¯å°å·§
        - æ”¯æŒ gzip å‹ç¼©
        - è‡ªåŠ¨å¤„ç† SPA è·¯ç”±
        - ä¼˜åŒ–çš„ç¼“å­˜ç­–ç•¥
        - å¤šæ¶æ„æ”¯æŒ (amd64/arm64)
        
        ## ç¯å¢ƒå˜é‡
        | å˜é‡å | æè¿° | é»˜è®¤å€¼ |
        |--------|------|--------|
        | TZ | æ—¶åŒºè®¾ç½® | Asia/Shanghai |
        
        EOF

    - name: ä¸Šä¼ éƒ¨ç½²è¯´æ˜
      uses: actions/upload-artifact@v4
      with:
        name: deployment-instructions-${{ github.event.inputs.version }}
        path: deployment-instructions.md

    - name: è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      run: |
        echo "ğŸ‰ Docker é•œåƒæ„å»ºæˆåŠŸï¼"
        echo "ğŸ“¦ é•œåƒåœ°å€: ${{ env.IMAGE_TAG }}"
        echo "ğŸ·ï¸  Latest æ ‡ç­¾: ${{ env.IMAGE_LATEST }}"
        echo "ğŸš€ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²ï¼š"
        echo "   docker run -d --name yansdmusic -p 80:80 ${{ env.IMAGE_TAG }}"
